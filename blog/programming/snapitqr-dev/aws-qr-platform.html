<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AWS Serverless QR Platform | SnapIT QR</title>
    <link rel="stylesheet" href="../../../styles.css">
</head>
<body>
    <nav class="nav">
        <div class="nav-container">
            <a href="../../../index.html" class="nav-logo">
                <span class="logo-text">Terrell K. Flautt</span>
            </a>
            <div class="nav-links">
                <a href="../../../index.html">Home</a>
                <a href="../index.html">Dev Blog</a>
            </div>
        </div>
    </nav>

    <article style="max-width: 800px; margin: 0 auto; padding: 2rem;">
        <header>
            <h1>AWS Serverless QR Platform</h1>
            <p><time>Oct 8, 2025</time> · 6 min · <a href="https://snapitqr.com" target="_blank">snapitqr.com</a></p>
        </header>

        <h2>Architecture</h2>
        <pre><code>React Frontend (S3/CloudFront)
    ↓
API Gateway + Lambda Functions
    ↓
DynamoDB + S3 Storage
    ↓
SSM Parameters (secrets)</code></pre>

        <h2>Core Components</h2>

        <h3>1. QR Generation Lambda</h3>
        <pre><code>exports.generateQR = async (event) => {
    const { url, options } = JSON.parse(event.body);

    // Get API keys from SSM
    const qrApiKey = await ssm.getParameter({
        Name: '/snapitqr/qr-api-key',
        WithDecryption: true
    }).promise();

    // Generate QR with custom branding
    const qrData = await qrcode.toDataURL(url, {
        errorCorrectionLevel: 'H',
        width: options.size || 512,
        color: {
            dark: options.darkColor || '#000',
            light: options.lightColor || '#fff'
        }
    });

    // Store in S3
    const s3Key = `qr-codes/${uuidv4()}.png`;
    await s3.upload({
        Bucket: 'snapitqr-assets',
        Key: s3Key,
        Body: Buffer.from(qrData.split(',')[1], 'base64'),
        ContentType: 'image/png'
    }).promise();

    // Save metadata to DynamoDB
    await dynamoDB.put({
        TableName: 'qr_codes',
        Item: {
            id: s3Key.split('/')[1].split('.')[0],
            url,
            s3Key,
            createdAt: new Date().toISOString(),
            userId: event.requestContext.authorizer?.userId,
            options
        }
    }).promise();

    return {
        statusCode: 200,
        body: JSON.stringify({
            id: s3Key.split('/')[1].split('.')[0],
            downloadUrl: `https://cdn.snapitqr.com/${s3Key}`
        })
    };
};</code></pre>

        <h3>2. Analytics Tracking Lambda</h3>
        <pre><code>exports.trackScan = async (event) => {
    const { qrId } = event.pathParameters;
    const userAgent = event.headers['User-Agent'];
    const ip = event.requestContext.identity.sourceIp;

    // Record scan analytics
    await dynamoDB.put({
        TableName: 'qr_scans',
        Item: {
            qrId,
            scanId: uuidv4(),
            timestamp: Date.now(),
            userAgent,
            ip,
            country: await getCountryFromIP(ip)
        }
    }).promise();

    // Get original URL
    const qrData = await dynamoDB.get({
        TableName: 'qr_codes',
        Key: { id: qrId }
    }).promise();

    // Redirect to original URL
    return {
        statusCode: 302,
        headers: {
            Location: qrData.Item.url,
            'Cache-Control': 'no-cache'
        }
    };
};</code></pre>

        <h3>3. React Frontend</h3>
        <pre><code>// QR Generator Component
function QRGenerator() {
    const [qrOptions, setQrOptions] = useState({
        url: '',
        size: 512,
        darkColor: '#000000',
        lightColor: '#ffffff'
    });

    const generateQR = async () => {
        const response = await fetch('/api/generate-qr', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(qrOptions)
        });

        const result = await response.json();
        setGeneratedQR(result);
    };

    return (
        &lt;div className="qr-generator"&gt;
            &lt;input
                value={qrOptions.url}
                onChange={(e) => setQrOptions({...qrOptions, url: e.target.value})}
                placeholder="Enter URL to encode"
            /&gt;
            &lt;ColorPicker
                value={qrOptions.darkColor}
                onChange={(color) => setQrOptions({...qrOptions, darkColor: color})}
            /&gt;
            &lt;button onClick={generateQR}&gt;Generate QR Code&lt;/button&gt;
        &lt;/div&gt;
    );
}</code></pre>

        <h2>DynamoDB Schema</h2>
        <pre><code>qr_codes table:
- id (string) - partition key
- url (string) - original URL
- s3Key (string) - S3 object key
- createdAt (string) - ISO timestamp
- userId (string) - owner ID
- options (map) - QR styling options

qr_scans table:
- qrId (string) - partition key
- scanId (string) - sort key
- timestamp (number) - scan time
- userAgent (string) - device info
- ip (string) - source IP
- country (string) - geo location</code></pre>

        <h2>SSM Parameters</h2>
        <pre><code>/snapitqr/qr-api-key - QR generation service key
/snapitqr/db-connection - Database connection string
/snapitqr/jwt-secret - JWT signing secret
/snapitqr/s3-bucket - Asset storage bucket
/snapitqr/google-oauth-client - OAuth client ID</code></pre>

        <h2>Key Fixes</h2>

        <h3>Cold Start Performance</h3>
        <p><strong>Problem:</strong> Lambda cold starts causing 2s+ delays.<br>
        <strong>Fix:</strong> Provisioned concurrency + connection pooling.</p>

        <pre><code>// Lambda connection pooling
let dynamoClient;
const getDynamoClient = () => {
    if (!dynamoClient) {
        dynamoClient = new AWS.DynamoDB.DocumentClient({
            region: process.env.AWS_REGION,
            maxRetries: 3
        });
    }
    return dynamoClient;
};</code></pre>

        <h3>CORS Configuration</h3>
        <p><strong>Problem:</strong> React app blocked by CORS policy.<br>
        <strong>Fix:</strong> API Gateway CORS + preflight handling.</p>

        <pre><code>// API Gateway CORS response
const corsHeaders = {
    'Access-Control-Allow-Origin': 'https://snapitqr.com',
    'Access-Control-Allow-Headers': 'Content-Type,Authorization',
    'Access-Control-Allow-Methods': 'GET,POST,PUT,DELETE,OPTIONS'
};</code></pre>

        <h3>Image Storage Optimization</h3>
        <p><strong>Problem:</strong> Large QR images slow download.<br>
        <strong>Fix:</strong> CloudFront CDN + automatic compression.</p>

        <pre><code>// S3 upload with optimization
await s3.upload({
    Bucket: 'snapitqr-assets',
    Key: s3Key,
    Body: optimizedImageBuffer,
    ContentType: 'image/png',
    CacheControl: 'max-age=31536000', // 1 year
    Metadata: {
        'original-size': originalSize.toString(),
        'compressed-size': compressedSize.toString()
    }
}).promise();</code></pre>

        <h2>Monitoring</h2>
        <pre><code>CloudWatch Metrics:
- Lambda duration/errors
- DynamoDB read/write capacity
- S3 request metrics
- API Gateway latency

Custom Dashboards:
- QR generation rate
- Scan analytics
- Error rates by function
- Cost per request</code></pre>

        <h2>Performance</h2>
        <ul>
            <li><strong>QR Generation:</strong> 200ms average</li>
            <li><strong>Scan Redirect:</strong> 50ms average</li>
            <li><strong>Cost:</strong> $0.01 per 100 QR codes</li>
            <li><strong>Scalability:</strong> 10,000+ concurrent requests</li>
        </ul>

        <footer style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid #333;">
            <p><strong>Stack:</strong> React, S3, CloudFront, API Gateway, Lambda, DynamoDB, SSM</p>
        </footer>
    </article>
</body>
</html>